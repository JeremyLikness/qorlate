/**
 * Correlated promises for AngularJS
 * @version v0.0.3-dev-2015-01-20
 * @link 
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";!function(a){function c(a){return b.isFunction(a)?a():a}function d(){}function e(){}b.extend(d.prototype,{id:1,getId:function(){var a=this.id;return this.id+=1,a}}),b.extend(e.prototype,{provider:new d,timeout:5e3,correlations:{},setDefaultTime:function(a){this.timeout=a},setProvider:function(a){this.provider=a},$get:["$q","$timeout",function(a,e){function f(d){var f,i,j=a.defer(),k=null,l=null,m=null,n=null,o=null;if(f=d&&d.id?c(d.id):g.provider.getId(),d&&d.subscribe){if(l=d.id||c(d.subscribe),l!==!!l)return m=l+":"+h.getId(),n={id:m},o={resolveFn:b.noop,rejectFn:b.noop},n.always=function(a,c){return o.resolveFn=a,o.rejectFn=c,function(){if(g.correlations[l]&&g.correlations[l][m]){var a=g.correlations[l][m];a.resolveFn=b.noop,a.rejectFn=b.noop,delete g.correlations[l][m]}}},g.correlations[l]||(g.correlations[l]=[]),g.correlations[l].push({subscriptionId:m}),g.correlations[l][m]=o,n;throw new Error("Subscription id is required.")}return i=c(d&&Object.prototype.hasOwnProperty.call(d,"timeout")?d.timeout:g.timeout),i&&i>=0&&(k=e(function(){j.rejected=!0,j.reject({message:"Qorlate request Timed out.",id:f})},i)),g.correlations[f]||(g.correlations[f]=[]),g.correlations[f].push({defer:j,timer:k,timeout:i}),{id:f,promise:j.promise}}var g=this,h=new d;return Object.defineProperty(f,"defaultTimeout",{configurable:!1,enumerable:!0,get:function(){return c(g.timeout)}}),f.immediate=function(b,c){var d=a.defer();return c?d.reject(b):d.resolve(b),d.promise},f.correlate=function(b,c,d){for(var f,h,i=!1,j=[];g.correlations[b]&&g.correlations[b].length;){if(f=g.correlations[b].pop(),f.subscriptionId){if(!g.correlations[b][f.subscriptionId])continue;i=!0,j.push(f.subscriptionId),h=g.correlations[b][f.subscriptionId],f.defer=a.defer(),f.defer.promise.then(h.resolveFn,h.rejectFn)}f.timer&&e.cancel(f.timer),f.defer.rejected||(i=!0,d?f.defer.reject(c):f.defer.resolve(c))}if(0===j.length)delete g.correlations[b];else for(;j.length;)g.correlations[b].push({subscriptionId:j.pop()});return i},f.reject=function(a,b){return this.correlate(a,b,!0)},f.resolve=function(a,b){return this.correlate(a,b,!1)},f}]}),a.provider("qorlate",e)}(b.module("jlikness.qorlate",[]))}(window,window.angular);