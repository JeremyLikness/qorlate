/**
 * Correlated promises for AngularJS
 * @version v0.0.2-dev-2015-01-20
 * @link 
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";!function(a){function c(a){return b.isFunction(a)?a():a}function d(){}function e(){}b.extend(d.prototype,{id:1,getId:function(){var a=this.id;return this.id+=1,a}}),b.extend(e.prototype,{provider:new d,timeout:5e3,correlations:{},setDefaultTime:function(a){this.timeout=a},setProvider:function(a){this.provider=a},$get:["$q","$timeout",function(a,e){function f(d){var f,i,j=a.defer(),k=null,l=null,m=null,n=null,o=null;if(f=d&&d.id?c(d.id):g.provider.getId(),d&&d.subscribe){if(l=d.id||c(d.subscribe),l!==!!l)return m=l+":"+h.getId(),n={id:m},o={resolveFn:b.noop,rejectFn:b.noop},n.always=function(a,c){return o.resolveFn=a,o.rejectFn=c,function(){if(g.correlations[l]&&g.correlations[l][m]){var a=g.correlations[l][m];a.resolveFn=b.noop,a.rejectFn=b.noop,delete g.correlations[l][m]}}},g.correlations[l]||(g.correlations[l]=[]),g.correlations[l].push({subscriptionId:m}),g.correlations[l][m]=o,n;throw new Error("Subscription id is required.")}return i=c(d&&Object.prototype.hasOwnProperty.call(d,"timeout")?d.timeout:g.timeout),i&&i>=0&&(k=e(function(){j.rejected=!0,j.reject({message:"Qorlate request Timed out.",id:f})},i)),g.correlations[f]||(g.correlations[f]=[]),g.correlations[f].push({defer:j,timer:k,timeout:i}),{id:f,promise:j.promise}}var g=this,h=new d;return Object.defineProperty(f,"defaultTimeout",{configurable:!1,enumerable:!0,get:function(){return c(g.timeout)}}),f.immediate=function(b,c){var d=a.defer();return c?d.reject(b):d.resolve(b),d.promise},f.correlate=function(a,b,c){for(var d,f,h=!1,i=[];g.correlations[a]&&g.correlations[a].length;)d=g.correlations[a].pop(),d.subscriptionId?g.correlations[a][d.subscriptionId]&&(h=!0,i.push(d.subscriptionId),f=g.correlations[a][d.subscriptionId],c?f.rejectFn(b):f.resolveFn(b)):(d.timer&&e.cancel(d.timer),d.defer.rejected||(h=!0,c?d.defer.reject(b):d.defer.resolve(b)));if(0===i.length)delete g.correlations[a];else for(;i.length;)g.correlations[a].push({subscriptionId:i.pop()});return h},f.reject=function(a,b){return this.correlate(a,b,!0)},f.resolve=function(a,b){return this.correlate(a,b,!1)},f}]}),a.provider("qorlate",e)}(b.module("jlikness.qorlate",[]))}(window,window.angular);